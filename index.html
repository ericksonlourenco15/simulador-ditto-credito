<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Simulador de Empréstimo Consignado Privado | Ditto Crédito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
  <style>
    .fase {
      transition: all 0.4s ease-in-out;
    }
    .erro {
      border: 2px solid red !important;
      background-color: #ffe6e6;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f8f8;
      color: #000000;
      padding: 20px;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background-color: #5FB371;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button:hover {
      background-color: #5F9183;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #5FB371;
      color: white;
    }
    #resultado {
      margin-top: 30px;
    }
    .etapaBarra span {
      display: inline-block;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #ccc;
      line-height: 30px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Simulador de Empréstimo Consignado Privado | Ditto Crédito</h2>

  <!-- Campo de simulação -->
  <label for="sexo">Sexo:</label>
  <select id="sexo">
    <option value="masculino">Masculino</option>
    <option value="feminino">Feminino</option>
  </select>

  <label for="dataNascimento">Data de Nascimento:</label>
  <input type="date" id="dataNascimento">

  <label for="dataInicio">Data de início da carteira assinada:</label>
  <input type="date" id="dataInicio">

  <label for="margem">Valor máximo de parcela (R$):</label>
  <input type="number" id="margem" step="0.01">

  <label for="tipoSimulacao">Tipo de simulação:</label>
  <select id="tipoSimulacao" onchange="document.getElementById('valorContratoGroup').style.display = this.value === 'contrato' ? 'block' : 'none';">
    <option value="parcela">Por valor da parcela</option>
    <option value="contrato">Por valor do contrato</option>
  </select>

  <div id="valorContratoGroup" style="display: none">
    <label for="valorContrato">Valor do contrato desejado (R$):</label>
    <input type="number" id="valorContrato" step="0.01">
  </div>

  <button onclick="simular()">Calcular Empréstimo</button>

  <div id="resultado"></div>

<script>
function simular() {
  const nascimento = document.getElementById('dataNascimento').value;
  const dataInicio = document.getElementById('dataInicio').value;
  const margem = parseFloat(document.getElementById('margem').value);
  const tipoSimulacao = document.getElementById('tipoSimulacao').value;
  const valorContrato = parseFloat(document.getElementById('valorContrato').value);
  const sexo = document.getElementById('sexo').value;
  const resultado = document.getElementById('resultado');
  resultado.innerHTML = '';

  if (!nascimento || !dataInicio || !margem || (tipoSimulacao === 'contrato' && !valorContrato)) {
    resultado.innerHTML = '<p style="color:red">Preencha todos os campos obrigatórios.</p>';
    return;
  }

  const hoje = new Date();
  const nasc = new Date(nascimento);
  let idade = hoje.getFullYear() - nasc.getFullYear();
  if (hoje.getMonth() < nasc.getMonth() || (hoje.getMonth() === nasc.getMonth() && hoje.getDate() < nasc.getDate())) {
    idade--;
  }

  const idadeMaxima = sexo === 'masculino' ? 62 : 57;
  if (idade < 21 || idade > idadeMaxima) {
    resultado.innerHTML = `<p style='color:red'>Idade inválida. Aceitamos entre 21 e ${idadeMaxima} anos.</p>`;
    return;
  }

  const inicio = new Date(dataInicio);
  const meses = (hoje.getFullYear() - inicio.getFullYear()) * 12 + hoje.getMonth() - inicio.getMonth();
  if (meses < 13) {
    resultado.innerHTML = '<p style="color:red">É necessário pelo menos 13 meses de carteira assinada.</p>';
    return;
  }

  const coeficientes = {
    6: 0.264905,
    8: 0.208688,
    10: 0.175092,
    12: 0.152844,
    18: 0.116357,
    24: 0.098813,
    36: 0.082661
  };

  const regrasPorTempo = [
    { min: 13, max: 24, parcelas: [6, 8], valorMin: 500, valorMax: 4000 },
    { min: 25, max: 36, parcelas: [6, 8, 10], valorMin: 500, valorMax: 6000 },
    { min: 37, max: 48, parcelas: [6, 8, 10, 12], valorMin: 500, valorMax: 8000 },
    { min: 49, max: 72, parcelas: [6, 8, 10, 12, 18, 24], valorMin: 500, valorMax: 10000 },
    { min: 73, max: 999, parcelas: [6, 8, 10, 12, 18, 24, 36], valorMin: 500, valorMax: 12000 }
  ];

  const faixa = regrasPorTempo.find(f => meses >= f.min && meses <= f.max);
  if (!faixa) {
    resultado.innerHTML = '<p style="color:red">Não há regras aplicáveis para esse tempo de carteira.</p>';
    return;
  }

  let html = `<p><strong>Idade:</strong> ${idade} anos</p>`;
  html += `<p><strong>Meses de carteira:</strong> ${meses} meses</p>`;

  if (tipoSimulacao === "parcela") {
    const parcelaMaxima = margem / 2;
    html += `<p><strong>Parcela máxima:</strong> R$ ${parcelaMaxima.toFixed(2)}</p>`;
    html += `<table><tr><th>Parcelas</th><th>Valor liberado</th><th>Ação</th></tr>`;
    faixa.parcelas.forEach(p => {
      const valor = parcelaMaxima / coeficientes[p];
      if (valor >= faixa.valorMin && valor <= faixa.valorMax) {
        html += `<tr><td>${p}x</td><td>R$ ${valor.toFixed(2)}</td><td><button onclick='abrirFormularioProposta(${valor}, ${p}, ${parcelaMaxima})'>Escolher</button></td></tr>`;
      }
    });
    html += `</table>`;
  } else {
    if (valorContrato < faixa.valorMin || valorContrato > faixa.valorMax) {
      resultado.innerHTML = `<p style="color:red">O valor do contrato deve estar entre R$ ${faixa.valorMin.toFixed(2)} e R$ ${faixa.valorMax.toFixed(2)} para esse tempo de carteira.</p>`;
      return;
    }
    html += `<p><strong>Valor contratado:</strong> R$ ${valorContrato.toFixed(2)}</p>`;
    html += `<table><tr><th>Parcelas</th><th>Valor da Parcela</th><th>Ação</th></tr>`;
    let algumaValida = false;
    faixa.parcelas.forEach(p => {
      const parcela = valorContrato * coeficientes[p];
      if (parcela <= margem / 2) {
        html += `<tr><td>${p}x</td><td>R$ ${parcela.toFixed(2)}</td><td><button onclick='abrirFormularioProposta(${valorContrato}, ${p}, ${parcela})'>Escolher</button></td></tr>`;
        algumaValida = true;
      }
    });
    html += `</table>`;
    if (!algumaValida) {
      resultado.innerHTML = `<p style='color:red'>Nenhuma opção disponível: o valor da parcela excede o limite de R$ ${(margem / 2).toFixed(2)} permitido.</p>`;
      return;
    }
  }
  resultado.innerHTML = html;
}
</script>

<script>
// Função para enviar os dados da proposta
$(document).ready(function() {
  $('#cpfConsultor, #cpfCliente').mask('000.000.000-00');
  $('#celularConsultor, #celularCliente').mask('(00) 00000-0000');
  $('#cep').mask('00000-000');
  $('#agencia').mask('0000');
  $('#conta').mask('00000000');
  $('#digito').mask('0');

  function validarCampos() {
    let valido = true;
    $('#formularioProposta input:visible').each(function() {
      if (!$(this).val()) {
        $(this).addClass('erro');
        valido = false;
      } else {
        $(this).removeClass('erro');
      }
    });
    return valido;
  }

  window.enviarProposta = function() {
    if (!validarCampos()) {
      alert('Por favor, preencha todos os campos obrigatórios.');
      return;
    }
    const dados = {};
    $('#formularioProposta input, #formularioProposta select').each(function() {
      dados[this.id] = $(this).val();
    });
    fetch('https://hook.us1.make.com/9kgf3swbxuvfcjprft6rp876vqfd7wnx', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    }).then(response => {
      if (response.ok) {
        alert('Proposta enviada com sucesso!');
        document.getElementById('formularioProposta').reset();
        location.reload();  // Recarrega a página
      } else {
        alert('Erro ao enviar a proposta.');
      }
    }).catch(() => alert('Erro de conexão ao enviar a proposta.'));
  }
});
</script>
</html>
