<!DOCTYPE html>
<script>
  const coeficientes = {
    6: 0.264905,
    8: 0.208688,
    10: 0.175092,
    12: 0.152844,
    18: 0.116357,
    24: 0.098813,
    36: 0.082661
  };

  const regrasPorTempo = [
    { min: 13, max: 24, parcelas: [6, 8], valorMin: 500, valorMax: 4000 },
    { min: 25, max: 36, parcelas: [6, 8, 10], valorMin: 500, valorMax: 6000 },
    { min: 37, max: 48, parcelas: [6, 8, 10, 12], valorMin: 500, valorMax: 8000 },
    { min: 49, max: 72, parcelas: [6, 8, 10, 12, 18, 24], valorMin: 500, valorMax: 10000 },
    { min: 73, max: 999, parcelas: [6, 8, 10, 12, 18, 24, 36], valorMin: 500, valorMax: 12000 }
  ];

  function simular() {
    const nascimento = document.getElementById('dataNascimento').value;
    const dataInicio = document.getElementById('dataInicio').value;
    const margem = parseFloat(document.getElementById('margem').value);
    const tipoSimulacao = document.getElementById('tipoSimulacao').value;
    const valorContratoDesejado = parseFloat(document.getElementById('valorContrato').value);
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = "";

    const sexo = document.getElementById('sexo').value;
    const idade = calcularIdade(nascimento);
    const idadeMaxima = sexo === 'masculino' ? 62 : 57;
    if (idade < 21 || idade > idadeMaxima) {
      resultado.innerHTML = `<p style='color:red'>Idade deve estar entre 21 e ${idadeMaxima} anos para o sexo ${sexo}.</p>`;
      return;
    }

    const meses = calcularMeses(dataInicio);
    if (meses < 13) {
      resultado.innerHTML = '<p style="color:red">Tempo mínimo de empresa: 13 meses.</p>';
      return;
    }

    const faixa = regrasPorTempo.find(f => meses >= f.min && meses <= f.max);
    if (!faixa) {
      resultado.innerHTML = '<p style="color:red">Sem regras para esse tempo de empresa.</p>';
      return;
    }

    let html = `<p><strong>Idade:</strong> ${idade} anos</p>`;
    html += `<p><strong>Tempo de carteira:</strong> ${meses} meses</p>`;

    if (tipoSimulacao === "parcela") {
      if (!margem || margem <= 0) {
        resultado.innerHTML = '<p style="color:red">Informe a margem disponível.</p>';
        return;
      }
      const valorParcela = margem / 2;
      html += `<p><strong>Parcela máxima:</strong> R$ ${valorParcela.toFixed(2)}</p>`;
      html += `<table><tr><th>Parcelas</th><th>Valor liberado</th><th>Ação</th></tr>`;
      faixa.parcelas.forEach(p => {
        const valor = (valorParcela / coeficientes[p]);
        if (valor >= faixa.valorMin && valor <= faixa.valorMax) {
          html += `<tr><td>${p}x</td><td>R$ ${valor.toFixed(2)}</td><td><button onclick='abrirFormularioProposta(${valor}, ${p}, ${valorParcela})'>Escolher</button></td></tr>`;
        }
      });
      html += `</table>`;
    } else {
      if (!valorContratoDesejado || valorContratoDesejado < faixa.valorMin || valorContratoDesejado > faixa.valorMax) {
        resultado.innerHTML = `<p style="color:red">Valor deve estar entre R$ ${faixa.valorMin.toFixed(2)} e R$ ${faixa.valorMax.toFixed(2)} para essa faixa.</p>`;
        return;
      }
      html += `<p><strong>Valor contratado:</strong> R$ ${valorContratoDesejado.toFixed(2)}</p>`;
      html += `<table><tr><th>Parcelas</th><th>Parcela mensal</th><th>Ação</th></tr>`;
      let algumaOpcaoValida = false;
      faixa.parcelas.forEach(p => {
        const parcela = valorContratoDesejado * coeficientes[p];
        if (parcela <= margem / 2) {
          html += `<tr><td>${p}x</td><td>R$ ${parcela.toFixed(2)}</td><td><button onclick='abrirFormularioProposta(${valorContratoDesejado}, ${p}, ${parcela})'>Escolher</button></td></tr>`;
          algumaOpcaoValida = true;
        }
      });
      html += `</table>`;
      if (!algumaOpcaoValida) {
        resultado.innerHTML = `<p style="color:red">Nenhuma opção disponível: o valor da parcela excede o limite de R$ ${(margem / 2).toFixed(2)} permitido.</p>`;
        return;
      }
    }
    resultado.innerHTML = html;
  }

  function calcularIdade(dataStr) {
    const hoje = new Date();
    const nascimento = new Date(dataStr);
    let idade = hoje.getFullYear() - nascimento.getFullYear();
    const m = hoje.getMonth() - nascimento.getMonth();
    if (m < 0 || (m === 0 && hoje.getDate() < nascimento.getDate())) idade--;
    return idade;
  }

  function calcularMeses(dataInicioStr) {
    const hoje = new Date();
    const inicio = new Date(dataInicioStr);
    return (hoje.getFullYear() - inicio.getFullYear()) * 12 + hoje.getMonth() - inicio.getMonth();
  }
</script>
